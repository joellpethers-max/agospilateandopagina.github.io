<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ponete las Pila-tes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --accent: #800020;
      --accent-2: #FFB4A2;
      --accent-3: #556B2F;
      --glass: rgba(255,255,255,0.08);
    }
    html,body { height:100%; }
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #111;
      color: #111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .hero-bg { 
      position: fixed; 
      inset:0; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      z-index: -2; 
      transform: scale(1.02); 
      transition: transform 0.8s ease; 
    }
    .hero-bg.animate { transform: scale(1.06); }
    .bg-overlay { position: fixed; inset:0; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.35) 100%); z-index: -1; }
    #login-panel { backdrop-filter: blur(6px) saturate(120%); background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
    .btn-accent { background: linear-gradient(90deg, var(--accent-3), var(--accent) 60%); color: white; box-shadow: 0 8px 20px rgba(128,0,32,0.25), 0 0 24px rgba(128,0,32,0.08) inset; transition: transform .18s ease, box-shadow .18s ease; }
    .btn-accent:hover { transform: translateY(-3px) scale(1.01); box-shadow: 0 12px 30px rgba(128,0,32,0.35); }
    .btn-accent:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .pulse { animation: pulse 1.8s infinite; }
    @keyframes pulse { 0%{ transform: scale(1); opacity: 0.9; } 50%{ transform: scale(1.06); opacity: 1; } 100%{ transform: scale(1); opacity: 0.9; } }
    #main-content { display: none; }
    #main-content.visible { display: block; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.88)); }
    @media (max-width: 640px) { .hero-title { font-size: 1.6rem; } #login-panel { padding: 1.2rem; } }
    .video-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center;
      color:white; font-weight:bold; font-size:1.1rem; border-radius:0.25rem;
      cursor:pointer; flex-direction: column; gap: 0.5rem;
    }
    .video-container { position:relative; }
    .accordion-header { cursor:pointer; }
    .fucsia-fina { color:#FF1493; font-weight:300; }
    .locked { opacity: 0.6; pointer-events: none; position: relative; }
    .lock-badge { position: absolute; top:8px; right:8px; background: rgba(0,0,0,0.7); color:white; padding:4px 8px; border-radius:6px; font-size:12px; font-weight: 600; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal { background:white; border-radius:12px; max-width:920px; width:95%; max-height:90vh; overflow:auto; padding:1.5rem; }
    .cover-membership { 
      background-size:cover; 
      background-position:center; 
      border-radius:12px; 
      height:280px; 
      position:relative; 
      display:flex; 
      align-items:flex-end; 
      padding:1.5rem; 
      color:white; 
      background: linear-gradient(135deg, var(--accent-3), var(--accent));
    }
    .cover-membership .cover-filter { 
      position:absolute; 
      inset:0; 
      background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6)); 
      border-radius:12px; 
      display:flex; 
      align-items:flex-end; 
      padding:1.5rem; 
    }
    .about-card { display:flex; gap:1rem; align-items:center; background: linear-gradient(180deg,#fff,#f9f9f9); padding:1.5rem; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .about-photo { width:120px; height:120px; border-radius:12px; object-fit:cover; flex-shrink:0; }
    .preview-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:12px; }
    .preview-thumb { position:relative; border-radius:8px; overflow:hidden; background:#000; cursor: pointer; transition: transform 0.2s; }
    .preview-thumb:hover { transform: scale(1.02); }
    .preview-thumb img { width:100%; height:140px; object-fit:cover; display:block; filter:brightness(0.7); }
    .preview-thumb .meta { padding:8px; font-size:14px; color: white; background: rgba(0,0,0,0.8); }
    .preview-play { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; pointer-events:none; }
    .success-badge { background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .nav-link { transition: all 0.2s; }
    .nav-link:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <div class="hero-bg" id="hero-bg" aria-hidden="true"></div>
  <div class="bg-overlay"></div>

  <!-- LOGIN / PREVIEW -->
  <div class="min-h-screen flex items-center justify-center px-4" style="gap:1.5rem;" id="login-wrapper">
    <div id="login-panel" class="rounded-3xl p-8 w-full max-w-4xl flex items-start gap-6 shadow-xl">
      <div class="flex-1 text-white">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <path d="M3 12c0-5 4-9 9-9s9 4 9 9" stroke="white" stroke-opacity="0.9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M6 16c2-2 5-3 8-3s6 1 8 3" stroke="var(--accent-2)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-extrabold" style="color: white;">Ponete las Pila-tes</h1>
            <p class="text-xs text-white/80">Conect√° cuerpo, mente y movimiento</p>
          </div>
        </div>

        <h2 class="hero-title text-3xl font-bold mb-2" style="color: #fff;">Bienvenido/a</h2>
        <p class="fucsia-fina mb-4 max-w-md" style="font-size: 0.95rem;">
          Un espacio creado con amor y dedicaci√≥n para ayudarte a conectar con tu cuerpo, tu respiraci√≥n y tu bienestar.
        </p>

        <div class="flex gap-3 items-center flex-wrap">
          <button id="btn-login-overlay" class="btn-accent rounded-xl px-5 py-2 font-semibold flex items-center gap-3">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M12 2v20" stroke="white" stroke-width="1.6"/><path d="M5 12h14" stroke="white" stroke-width="1.6"/></svg>
            Entrar / Registrarme
          </button>
          <a id="btn-guest" class="px-4 py-2 rounded-lg border border-white/12 text-white/90 hover:bg-white/6 cursor-pointer">Ver demo</a>
        </div>

        <p class="text-xs text-white/60 mt-4 max-w-sm">
          Demo: pod√©s explorar sin cuenta, pero no reproducir videos completos. Al iniciar sesi√≥n acept√°s nuestras pol√≠ticas.
        </p>
      </div>

      <!-- Vista previa de compra -->
      <div class="w-80 bg-white/8 p-4 rounded-xl">
        <h3 class="text-lg font-semibold text-white mb-2">üî• Oferta: Nivel Inicial</h3>
        <p class="text-sm text-white/80 mb-2">USD 49 ‚Äî 3 ejes con videos y ex√°menes. Pag√° y guard√° tu progreso.</p>
        <div class="flex gap-2">
          <button id="btn-mini-pay" class="btn-accent px-3 py-1 rounded flex-1 text-sm font-semibold">Comprar USD 49</button>
        </div>
        <ul class="text-xs text-white/70 mt-3 space-y-1">
          <li>‚úì Acceso de por vida</li>
          <li>‚úì 3 ejes progresivos</li>
          <li>‚úì Ex√°menes de aprobaci√≥n</li>
          <li>‚úì Progreso guardado</li>
        </ul>
        <p class="text-xs text-white/50 mt-3">Demo: solo vista previa. Registrate y pag√° para desbloquear.</p>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main-content" class="min-h-screen overlay pt-6 pb-12">
    <nav class="flex justify-between items-center px-8 py-4" style="background: linear-gradient(90deg, var(--accent-3), var(--accent)); color: white;">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M3 12c0-5 4-9 9-9s9 4 9 9" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M6 16c2-2 5-3 8-3s6 1 8 3" stroke="var(--accent-2)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-white">Ponete las Pila-tes</h1>
      </div>
      <ul class="flex items-center gap-6">
        <li><a href="#membresia" class="text-white/90 hover:text-white nav-link">Membres√≠a</a></li>
        <li><a href="#cursos" class="text-white/90 hover:text-white nav-link">Cursos</a></li>
        <li><a href="#talleres" class="text-white/90 hover:text-white nav-link">Talleres</a></li>
        <li><a href="#sobre-mi" class="text-white/90 hover:text-white nav-link">Sobre m√≠</a></li>
        <li><button id="btn-login" class="px-3 py-1 border rounded bg-[var(--accent-2)] text-[var(--accent)] font-semibold hover:bg-opacity-90">Entrar</button></li>
      </ul>
    </nav>

    <!-- MEMBRES√çA (ARRIBA) -->
    <section id="membresia" class="px-8 py-8 max-w-6xl mx-auto">
      <div class="cover-membership mb-4" id="membership-cover">
        <div class="cover-filter">
          <div style="z-index:2;">
            <h2 class="text-3xl font-bold">Membres√≠a: Clases Martes y Jueves</h2>
            <p class="text-sm">Clases en vivo por Zoom + videos grabados. Acceso solo para suscriptores.</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-white rounded shadow-sm">
          <h3 class="font-semibold text-[var(--accent-3)] text-xl">Membres√≠a Mensual</h3>
          <p class="mt-1 font-bold text-[var(--accent)] text-2xl">USD <span id="membership-price">99</span></p>
          <p class="text-xs text-gray-600 mt-2">Acceso a clases en vivo (Zoom) los Martes y Jueves, videos grabados y recursos. Solo suscriptores pueden ver videos completos y unirse al Zoom.</p>
          <div class="flex gap-2 mt-3 flex-col">
            <button id="btn-pay-membership" class="btn-accent px-3 py-2 rounded font-semibold">Pagar Membres√≠a</button>
            <button id="btn-membership-open" class="px-3 py-2 rounded border text-[var(--accent-3)] hover:bg-gray-50">Ver Clases Grabadas</button>
            <button id="btn-join-zoom" class="px-3 py-2 rounded border text-white bg-[var(--accent-3)] hover:bg-opacity-90 hidden font-semibold">Unirse al Zoom en Vivo</button>
          </div>
        </div>

        <div class="col-span-2 p-4 bg-white rounded shadow-sm">
          <div id="membership-info">
            <h4 class="font-semibold mb-2 text-[var(--accent-3)]">Informaci√≥n de la membres√≠a</h4>
            <ul class="text-sm text-gray-700 space-y-1">
              <li>üìÖ Clases en vivo: Martes y Jueves a las 19:00 hs</li>
              <li>üìπ Videos grabados de todas las clases</li>
              <li>üí™ Rutinas progresivas y personalizadas</li>
              <li>üéØ Acceso ilimitado mientras tu membres√≠a est√© activa</li>
            </ul>
          </div>
          <div id="membership-preview" class="mt-4" style="display:none;">
            <h4 class="font-semibold mb-2 text-[var(--accent-3)]">Clases grabadas disponibles</h4>
            <div id="preview-grid" class="preview-grid"></div>
            <p id="preview-note" class="text-xs text-gray-500 mt-3">Para ver el video completo, registrate y pag√° la membres√≠a.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- SOBRE M√ç -->
    <section id="sobre-mi" class="px-8 py-8 max-w-6xl mx-auto">
      <h3 class="text-3xl font-semibold text-[var(--accent-3)] mb-4">Sobre m√≠</h3>
      <div class="about-card">
        <div class="about-photo bg-gradient-to-br from-[var(--accent-3)] to-[var(--accent)] flex items-center justify-center text-white text-4xl font-bold">
          AB
        </div>
        <div>
          <h4 class="text-xl font-bold text-[var(--accent)]">Agostina Bonnet</h4>
          <p class="text-sm text-gray-700 mt-2">
            Soy Agostina Bonnet, profesora de Educaci√≥n F√≠sica e instructora certificada de Pilates (mat y reformer). Trabajo acompa√±ando a mis alumnas y alumnos a mejorar la movilidad, la postura y la conexi√≥n mente-cuerpo a trav√©s de pr√°cticas seguras y progresivas. Mi enfoque combina t√©cnica, respiraci√≥n y flujos orientados a resultados reales: m√°s fuerza, estabilidad y bienestar.
          </p>
          <p class="text-sm text-gray-600 mt-3">
            Clases en vivo los martes y jueves. Tambi√©n encontrar√°s clases grabadas, talleres y programas por niveles.
          </p>
          <div class="mt-3 flex gap-3 flex-wrap">
            <a href="#membresia" class="px-4 py-2 rounded bg-[var(--accent)] text-white hover:bg-opacity-90">Unirme a la membres√≠a</a>
            <a href="#cursos" class="px-4 py-2 rounded border text-[var(--accent-3)] hover:bg-gray-50">Ver cursos</a>
          </div>
        </div>
      </div>
    </section>

    <!-- CURSOS -->
    <section id="cursos" class="px-8 py-12 max-w-6xl mx-auto">
      <h3 class="text-3xl font-semibold text-[var(--accent-3)] mb-6">Cursos</h3>
      <div id="courses" class="space-y-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      <div id="course-detail" class="hidden space-y-4 mt-8"></div>
    </section>

    <!-- TALLERES -->
    <section id="talleres" class="px-8 py-12 max-w-6xl mx-auto">
      <h3 class="text-3xl font-semibold text-[var(--accent)] mb-6">Talleres</h3>
      <div id="workshops" class="space-y-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <footer class="text-center py-6 mt-12" style="background: linear-gradient(90deg, var(--accent-3), var(--accent)); color: white;">
      <p>&copy; 2025 Ponete las Pila-tes. Todos los derechos reservados.</p>
      <p class="text-xs mt-2 text-white/70">Desarrollado con ‚ù§Ô∏è para el bienestar</p>
    </footer>
  </div>

  <!-- Modal -->
  <div id="modal-root" style="display:none;"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyAZTU_s3OrJxmJ0fy3qEjXu6J2wDBciglo",
  authDomain: "pilateandoconagos.firebaseapp.com",
  projectId: "pilateandoconagos",
  storageBucket: "pilateandoconagos.appspot.com",
  messagingSenderId: "159697443475",
  appId: "1:159697443475:web:8c4eec3832332064f48b66",
  measurementId: "G-7WY9D4J6H5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const MP_ACCESS_TOKEN = 'APP_USR-9bd267a7-6de7-4597-942f-333b92a7df07';

const demoMembership = [{
  id: 'membresia-2025',
  title: 'Membres√≠a Martes y Jueves',
  price: 99,
  zoom: [
    { label: 'Martes 19:00 hs', url: 'https://zoom.us/j/ejemplo-martes' },
    { label: 'Jueves 19:00 hs', url: 'https://zoom.us/j/ejemplo-jueves' }
  ],
  videos: [
    { title: 'Clase 1: Fundamentos', url: 'https://www.youtube.com/embed/nolkPq64TrY', thumb: 'https://img.youtube.com/vi/nolkPq64TrY/hqdefault.jpg' },
    { title: 'Clase 2: Postura y Alineaci√≥n', url: 'https://www.youtube.com/embed/nolkPq64TrY', thumb: 'https://img.youtube.com/vi/nolkPq64TrY/hqdefault.jpg' },
    { title: 'Clase 3: Respiraci√≥n Consciente', url: 'https://www.youtube.com/embed/nolkPq64TrY', thumb: 'https://img.youtube.com/vi/nolkPq64TrY/hqdefault.jpg' },
    { title: 'Clase 4: Core y Estabilidad', url: 'https://www.youtube.com/embed/nolkPq64TrY', thumb: 'https://img.youtube.com/vi/nolkPq64TrY/hqdefault.jpg' }
  ]
}];

const demoCourses = [
  { 
    id: 'basic', 
    title: 'Nivel Inicial', 
    description: 'Aprend√© desde cero los fundamentos del Pilates', 
    price: 49, 
    ejes: [
      {
        id: 'b-eje1', 
        title: 'Eje 1 - Fundamentos del Pilates', 
        videos: [
          { title: 'Introducci√≥n al Pilates', url: 'https://www.youtube.com/embed/nolkPq64TrY' },
          { title: 'Principios b√°sicos', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øCu√°l es el principio fundamental del Pilates?', 
          options: ['Control y precisi√≥n', 'Velocidad y fuerza', 'Resistencia m√°xima', 'Flexibilidad extrema'], 
          answer: 0
        }
      },
      {
        id: 'b-eje2', 
        title: 'Eje 2 - Postura y Alineaci√≥n', 
        videos: [
          { title: 'Alineaci√≥n de la columna', url: 'https://www.youtube.com/embed/nolkPq64TrY' },
          { title: 'Ejercicios de postura', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øCu√°l es la posici√≥n neutral de la pelvis?', 
          options: ['Rotaci√≥n anterior', 'Posici√≥n neutra sin rotaci√≥n', 'Rotaci√≥n posterior'], 
          answer: 1
        }
      },
      {
        id: 'b-eje3', 
        title: 'Eje 3 - Respiraci√≥n y Flujo', 
        videos: [
          { title: 'T√©cnicas de respiraci√≥n', url: 'https://www.youtube.com/embed/nolkPq64TrY' },
          { title: 'Flujo de movimiento', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øC√≥mo debe ser la respiraci√≥n en Pilates?', 
          options: ['Superficial', 'Profunda y tor√°cica', 'Irregular'], 
          answer: 1
        }
      }
    ]
  },
  { 
    id: 'intermedio', 
    title: 'Nivel Intermedio', 
    description: 'Avanz√° en tu pr√°ctica con ejercicios m√°s complejos', 
    price: 59, 
    ejes: [
      {
        id: 'i-eje1', 
        title: 'Eje 1 - Fortalecimiento del Core', 
        videos: [
          { title: 'Core avanzado', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øQu√© m√∫sculos forman el core?', 
          options: ['Solo abdominales', 'Abdomen, espalda baja, pelvis', 'Solo la espalda'], 
          answer: 1
        }
      },
      {
        id: 'i-eje2', 
        title: 'Eje 2 - Control y Precisi√≥n', 
        videos: [
          { title: 'Movimientos controlados', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øQu√© es m√°s importante en Pilates intermedio?', 
          options: ['Cantidad de repeticiones', 'Calidad y control del movimiento'], 
          answer: 1
        }
      },
      {
        id: 'i-eje3', 
        title: 'Eje 3 - Secuencias Din√°micas', 
        videos: [
          { title: 'Secuencias fluidas', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øC√≥mo deben encadenarse los ejercicios?', 
          options: ['Con pausas largas', 'Con fluidez y transiciones suaves'], 
          answer: 1
        }
      }
    ]
  },
  { 
    id: 'elite', 
    title: 'Nivel Elite', 
    description: 'Para practicantes avanzados que buscan dominar el Pilates', 
    price: 79, 
    ejes: [
      {
        id: 'e-eje1', 
        title: 'Eje 1 - Ejercicios Avanzados', 
        videos: [
          { title: 'Ejercicios complejos', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øQu√© caracteriza al nivel elite?', 
          options: ['Velocidad', 'Control total y precisi√≥n m√°xima'], 
          answer: 1
        }
      },
      {
        id: 'e-eje2', 
        title: 'Eje 2 - Intensidad y Resistencia', 
        videos: [
          { title: 'Entrenamiento intensivo', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øC√≥mo se aumenta la intensidad?', 
          options: ['Solo con m√°s peso', 'Con control, tiempo bajo tensi√≥n y complejidad'], 
          answer: 1
        }
      },
      {
        id: 'e-eje3', 
        title: 'Eje 3 - Maestr√≠a y Perfecci√≥n', 
        videos: [
          { title: 'Perfeccionamiento t√©cnico', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
        ], 
        quiz: {
          q: '¬øQu√© define a un practicante elite?',
          options: ['Hacer muchos ejercicios', 'Dominio t√©cnico y conexi√≥n mente-cuerpo perfecta'],
          answer: 1
        }
      }
    ]
  }
];

const demoWorkshops = [
  { 
    id: 'taller1', 
    title: 'Taller: Respiraci√≥n y Relajaci√≥n', 
    description: 'Aprend√© t√©cnicas de respiraci√≥n para el bienestar',
    price: 29, 
    videos: [
      { title: 'T√©cnicas de respiraci√≥n', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
    ], 
    quiz: {
      q: '¬øCu√°l es el beneficio principal de la respiraci√≥n consciente?', 
      options: ['Quemar calor√≠as', 'Reducir estr√©s y mejorar oxigenaci√≥n'], 
      answer: 1
    }
  },
  { 
    id: 'taller2', 
    title: 'Taller: Pilates para la Espalda', 
    description: 'Ejercicios espec√≠ficos para fortalecer y cuidar tu espalda',
    price: 35, 
    videos: [
      { title: 'Cuidado de la espalda', url: 'https://www.youtube.com/embed/nolkPq64TrY' }
    ], 
    quiz: {
      q: '¬øQu√© ejercicio es mejor para la espalda baja?', 
      options: ['Bird dog', 'Saltos', 'Peso muerto sin t√©cnica'], 
      answer: 0
    }
  }
];

const coursesEl = document.getElementById('courses');
const workshopsEl = document.getElementById('workshops');
const courseDetailEl = document.getElementById('course-detail');
const heroBg = document.getElementById('hero-bg');
const btnLoginOverlay = document.getElementById('btn-login-overlay');
const btnLoginNav = document.getElementById('btn-login');
const btnGuest = document.getElementById('btn-guest');
const btnMiniPay = document.getElementById('btn-mini-pay');
const btnPayMembership = document.getElementById('btn-pay-membership');
const btnMembershipOpen = document.getElementById('btn-membership-open');
const membershipPreviewEl = document.getElementById('membership-preview');
const previewGrid = document.getElementById('preview-grid');
const btnJoinZoom = document.getElementById('btn-join-zoom');

let currentUser = null;
let isDemo = false;

async function createPreference(itemTitle, itemPrice, itemId) {
  try {
    const resp = await fetch('https://api.mercadopago.com/checkout/preferences', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${MP_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        items: [{
          title: itemTitle,
          quantity: 1,
          currency_id: 'USD',
          unit_price: Number(itemPrice)
        }],
        back_urls: {
          success: window.location.href,
          failure: window.location.href,
          pending: window.location.href
        },
        auto_return: 'approved',
        external_reference: itemId
      })
    });
    const data = await resp.json();
    return data;
  } catch (e) {
    console.error('Error creando preferencia:', e);
    throw e;
  }
}

async function processPayment(itemId, price, title) {
  if (!currentUser) {
    alert("Deb√©s iniciar sesi√≥n primero para realizar una compra.");
    return;
  }
  
  try {
    const pref = await createPreference(title || itemId, price, itemId);
    if (!pref || !pref.init_point) {
      alert('No fue posible generar la preferencia de pago.');
      console.error(pref);
      return;
    }
    
    const pendingRef = doc(db, 'users', currentUser.uid, 'pendingPayments', pref.id);
    await setDoc(pendingRef, {
      itemId,
      price,
      title,
      prefId: pref.id,
      createdAt: new Date().toISOString()
    });

    window.open(pref.init_point, '_blank');
    alert('Se abri√≥ Mercado Pago en una nueva pesta√±a. Complet√° el pago y volv√© a esta p√°gina.');
  } catch (e) {
    console.error(e);
    alert('Error al iniciar el pago: ' + (e.message || e));
  }
}

async function handleReturnFromMP() {
  const url = new URL(window.location.href);
  const status = url.searchParams.get('collection_status') || url.searchParams.get('status');
  const preference_id = url.searchParams.get('preference_id');
  const collection_id = url.searchParams.get('collection_id') || url.searchParams.get('payment_id');

  if (!preference_id || !status) return;
  
  if (status.toLowerCase() === 'approved') {
    if (auth.currentUser) {
      try {
        const pendingRef = doc(db, 'users', auth.currentUser.uid, 'pendingPayments', preference_id);
        const pendingSnap = await getDoc(pendingRef);
        
        let itemId = preference_id;
        let price = null;
        let title = null;
        
        if (pendingSnap.exists()) {
          const data = pendingSnap.data();
          itemId = data.itemId || preference_id;
          price = data.price || null;
          title = data.title || null;
        }
        
        const purchaseRef = doc(db, 'users', auth.currentUser.uid, 'purchases', itemId);
        await setDoc(purchaseRef, {
          paid: true,
          prefId: preference_id,
          collection_id: collection_id,
          timestamp: new Date().toISOString(),
          price,
          title
        });
        
        if (pendingSnap.exists()) {
          await updateDoc(pendingRef, {
            reconciled: true,
            reconciledAt: new Date().toISOString()
          });
        }
        
        alert('¬°Pago confirmado! Gracias por tu compra. Tu acceso ha sido habilitado.');
        
        await renderMembership();
        await renderCourses();
        await renderWorkshops();
        updateZoomButtonVisibility();
        
        url.searchParams.delete('collection_status');
        url.searchParams.delete('status');
        url.searchParams.delete('preference_id');
        url.searchParams.delete('collection_id');
        url.searchParams.delete('payment_id');
        history.replaceState({}, document.title, url.pathname);
      } catch (e) {
        console.error('Error reconciliando pago:', e);
      }
    } else {
      alert('Pago aprobado pero no est√°s logueado. Inici√° sesi√≥n para que el sistema registre tu pago.');
    }
  }
}

async function hasPaid(userId, itemId) {
  if (!userId) return false;
  const docRef = doc(db, 'users', userId, 'purchases', itemId);
  const docSnap = await getDoc(docRef);
  return docSnap.exists() && docSnap.data().paid;
}

async function getUserProgress(userId, courseId) {
  if (!userId) return { approvedEjes: [] };
  const ref = doc(db, 'users', userId, 'progress', courseId);
  const snap = await getDoc(ref);
  if (!snap.exists()) return { approvedEjes: [] };
  return snap.data();
}

async function markEjeApproved(userId, courseId, ejeId) {
  if (!userId) return;
  const ref = doc(db, 'users', userId, 'progress', courseId);
  try {
    const snap = await getDoc(ref);
    if (snap.exists()) {
      await updateDoc(ref, {
        approvedEjes: arrayUnion(ejeId),
        updatedAt: serverTimestamp()
      });
    } else {
      await setDoc(ref, {
        approvedEjes: [ejeId],
        updatedAt: serverTimestamp()
      });
    }
  } catch (e) {
    console.error('Error marcando eje aprobado:', e);
  }
}

async function renderMembership() {
  const m = demoMembership[0];
  const paid = currentUser ? await hasPaid(currentUser.uid, m.id) : false;
  
  document.getElementById('membership-price').innerText = m.price;
  
  if (btnPayMembership) {
    btnPayMembership.disabled = paid;
    btnPayMembership.innerText = paid ? '‚úì Suscripci√≥n activa' : 'Pagar Membres√≠a';
    btnPayMembership.onclick = async () => {
      if (!currentUser) {
        alert('Inici√° sesi√≥n para comprar la membres√≠a.');
        return;
      }
      await processPayment(m.id, m.price, m.title);
    };
  }
  
  updateZoomButtonVisibility();
}

function populatePreviewGrid() {
  previewGrid.innerHTML = '';
  const m = demoMembership[0];
  
  m.videos.forEach((v, idx) => {
    const thumb = document.createElement('div');
    thumb.className = 'preview-thumb';
    
    const img = document.createElement('img');
    img.src = v.thumb || 'https://img.youtube.com/vi/nolkPq64TrY/hqdefault.jpg';
    
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerText = v.title;
    
    const play = document.createElement('div');
    play.className = 'preview-play';
    play.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" fill="rgba(255,255,255,0.9)"/></svg>';
    
    thumb.appendChild(img);
    thumb.appendChild(play);
    thumb.appendChild(meta);
    
    thumb.onclick = async () => {
      const paid = currentUser ? await hasPaid(currentUser.uid, m.id) : false;
      if (paid && !isDemo) {
        openVideoModal(v.url, v.title);
      } else {
        openPreviewModal(v, paid);
      }
    };
    
    previewGrid.appendChild(thumb);
  });
}

function openVideoModal(src, title) {
  const root = document.getElementById('modal-root');
  root.style.display = 'block';
  root.innerHTML = `
    <div class="modal-backdrop" id="video-modal-back">
      <div class="modal p-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">${title}</h3>
          <button id="video-modal-close" class="px-3 py-1 rounded border hover:bg-gray-100">Cerrar</button>
        </div>
        <div style="position:relative;padding-top:56.25%;">
          <iframe src="${src}?rel=0&controls=1" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  `;
  document.getElementById('video-modal-close').onclick = () => {
    root.style.display = 'none';
    root.innerHTML = '';
  };
}

function openPreviewModal(video, paid) {
  const root = document.getElementById('modal-root');
  root.style.display = 'block';
  root.innerHTML = `
    <div class="modal-backdrop" id="preview-modal-back">
      <div class="modal p-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-bold">Preview: ${video.title}</h3>
          <button id="preview-modal-close" class="px-3 py-1 rounded border hover:bg-gray-100">Cerrar</button>
        </div>
        <p class="text-sm text-gray-600 mb-3">Est√°s viendo una vista previa. Para ver el video completo, registrate y pag√° la membres√≠a.</p>
        <div style="position:relative;padding-top:56.25%;">
          <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;color:white;font-size:18px;text-align:center;padding:20px;">
            üîí Video bloqueado<br><small>Registrate y pag√° para ver el contenido completo</small>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="preview-cta-pay" class="btn-accent px-3 py-1 rounded">Pagar membres√≠a</button>
          <button id="preview-cta-register" class="px-3 py-1 rounded border hover:bg-gray-100">Iniciar sesi√≥n / Registrar</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('preview-modal-close').onclick = () => {
    root.style.display = 'none';
    root.innerHTML = '';
  };
  document.getElementById('preview-cta-pay').onclick = async () => {
    if (!currentUser) {
      alert('Inici√° sesi√≥n para comprar la membres√≠a.');
      return;
    }
    await processPayment(demoMembership[0].id, demoMembership[0].price, demoMembership[0].title);
  };
  document.getElementById('preview-cta-register').onclick = () => login();
}

async function renderCourses() {
  coursesEl.innerHTML = '';
  courseDetailEl.innerHTML = '';
  courseDetailEl.classList.add('hidden');
  
  for (const c of demoCourses) {
    const card = document.createElement('div');
    card.className = 'p-4 bg-white rounded shadow-sm flex flex-col hover:shadow-md transition-shadow';
    
    card.innerHTML = `
      <h4 class="font-semibold text-[var(--accent-3)] text-lg">${c.title}</h4>
      <p class="text-sm text-gray-500 mt-1">${c.description}</p>
      <p class="mt-2 font-bold text-[var(--accent)] text-xl">USD ${c.price}</p>
    `;
    
    const btn = document.createElement('button');
    btn.className = 'btn-accent px-3 py-2 rounded mt-3 font-semibold';
    btn.innerText = 'Ver curso';
    btn.onclick = () => showCourseDetail(c);
    card.appendChild(btn);
    
    const status = document.createElement('div');
    status.className = 'text-sm mt-2';
    if (currentUser) {
      hasPaid(currentUser.uid, c.id).then(p => {
        if (p) {
          status.innerHTML = '<span class="success-badge">‚úì Comprado</span>';
        } else {
          status.innerHTML = '<span class="text-gray-600">Pago requerido</span>';
        }
      });
    } else {
      status.innerText = 'Inici√° sesi√≥n para comprar';
      status.className = 'text-sm mt-2 text-gray-500';
    }
    card.appendChild(status);
    
    coursesEl.appendChild(card);
  }
}

async function showCourseDetail(course) {
  courseDetailEl.innerHTML = '';
  courseDetailEl.classList.remove('hidden');
  
  const backBtn = document.createElement('button');
  backBtn.className = 'btn-accent px-3 py-2 rounded mb-4';
  backBtn.innerText = '‚Üê Volver a cursos';
  backBtn.onclick = () => {
    courseDetailEl.classList.add('hidden');
    coursesEl.scrollIntoView({ behavior: 'smooth' });
  };
  courseDetailEl.appendChild(backBtn);
  
  const title = document.createElement('h4');
  title.className = 'text-2xl font-bold text-[var(--accent-3)] mb-2';
  title.innerText = course.title;
  courseDetailEl.appendChild(title);
  
  const desc = document.createElement('p');
  desc.className = 'text-gray-600 mb-4';
  desc.innerText = course.description;
  courseDetailEl.appendChild(desc);
  
  const paid = currentUser ? await hasPaid(currentUser.uid, course.id) : false;
  
  if (!paid) {
    const payBtn = document.createElement('button');
    payBtn.className = 'btn-accent px-4 py-2 rounded mb-4 font-semibold';
    payBtn.innerText = `Comprar curso - USD ${course.price}`;
    payBtn.onclick = async () => {
      if (!currentUser) {
        alert('Inici√° sesi√≥n para comprar el curso.');
        return;
      }
      await processPayment(course.id, course.price, course.title);
    };
    courseDetailEl.appendChild(payBtn);
    
    if (isDemo) {
      const d = document.createElement('p');
      d.className = 'text-sm text-gray-600 mb-4 bg-yellow-50 p-3 rounded border border-yellow-200';
      d.innerText = '‚ö†Ô∏è Modo demo: no pod√©s acceder al contenido. Registrate y pag√° para desbloquear.';
      courseDetailEl.appendChild(d);
    }
  } else {
    const paidBadge = document.createElement('div');
    paidBadge.className = 'mb-4';
    paidBadge.innerHTML = '<span class="success-badge">‚úì Curso comprado</span>';
    courseDetailEl.appendChild(paidBadge);
  }
  
  const progress = currentUser ? await getUserProgress(currentUser.uid, course.id) : { approvedEjes: [] };
  const approvedSet = new Set(progress.approvedEjes || []);
  
  for (let i = 0; i < course.ejes.length; i++) {
    const eje = course.ejes[i];
    const ejeCard = document.createElement('div');
    ejeCard.className = 'border rounded-lg p-4 mb-3 relative bg-white shadow-sm';
    
    const header = document.createElement('div');
    header.className = 'accordion-header font-semibold text-lg flex justify-between items-center';
    header.innerHTML = `
      <span>${eje.title}</span>
      <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    `;
    
    const content = document.createElement('div');
    content.className = 'mt-3 hidden';
    
    header.onclick = () => {
      content.classList.toggle('hidden');
      header.querySelector('svg').classList.toggle('rotate-180');
    };
    
    let unlocked = false;
    if (!paid) {
      unlocked = false;
    } else {
      if (i === 0) {
        unlocked = true;
      } else {
        const prev = course.ejes[i - 1];
        unlocked = approvedSet.has(prev.id);
      }
    }
    
    for (const v of eje.videos) {
      const videoContainer = document.createElement('div');
      videoContainer.className = 'video-container my-3 rounded overflow-hidden';
      
      const iframe = document.createElement('iframe');
      iframe.src = v.url + '?controls=1&rel=0';
      iframe.width = '100%';
      iframe.height = 240;
      iframe.style.border = 'none';
      
      if (!unlocked || isDemo) {
        iframe.style.opacity = '0.4';
        iframe.style.pointerEvents = 'none';
        
        const overlay = document.createElement('div');
        overlay.className = 'video-overlay';
        overlay.innerHTML = `
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13v6l5.25 3.15.75-1.23-4.5-2.67V7H11z" fill="white"/>
          </svg>
          <span>${isDemo ? 'üîí Demo - Registrate para ver' : (!paid ? 'üîí Pag√° el curso' : 'üîí Aprob√° el eje anterior')}</span>
        `;
        overlay.onclick = () => {
          if (isDemo) {
            alert('Modo demo: registrate y pag√° para desbloquear este contenido.');
          } else if (!paid) {
            alert('Deb√©s pagar el curso para acceder a los videos.');
          } else {
            alert('Aprob√° el examen del eje anterior para desbloquear este contenido.');
          }
        };
        videoContainer.appendChild(iframe);
        videoContainer.appendChild(overlay);
      } else {
        const playBtn = document.createElement('button');
        playBtn.className = 'mt-2 btn-accent px-3 py-1 rounded text-sm';
        playBtn.innerText = 'Abrir video en grande';
        playBtn.onclick = () => openVideoModal(v.url, v.title);
        videoContainer.appendChild(iframe);
        videoContainer.appendChild(playBtn);
      }
      
      content.appendChild(videoContainer);
    }
    
    const quizContainer = document.createElement('div');
    quizContainer.className = 'mt-4 p-3 bg-gray-50 rounded border';
    
    const qTitle = document.createElement('h5');
    qTitle.className = 'font-semibold mb-2';
    qTitle.innerText = 'üìù Examen del eje';
    quizContainer.appendChild(qTitle);
    
    const qText = document.createElement('p');
    qText.className = 'font-medium mb-2';
    qText.innerText = eje.quiz.q;
    quizContainer.appendChild(qText);
    
    eje.quiz.options.forEach((opt, iopt) => {
      const btn = document.createElement('button');
      btn.className = 'block w-full text-left border rounded p-2 my-1 hover:bg-white transition';
      btn.innerText = opt;
      btn.onclick = async () => {
        if (!unlocked) {
          alert('No pod√©s rendir este examen hasta desbloquear el eje.');
          return;
        }
        if (isDemo) {
          alert('Modo demo: no se guardan avances. Registrate y pag√° para aprobar el eje.');
          return;
        }
        if (!currentUser) {
          alert('Inici√° sesi√≥n para guardar tu progreso.');
          return;
        }
        if (iopt === eje.quiz.answer) {
          alert('‚úì ¬°Correcto! Eje aprobado.');
          await markEjeApproved(currentUser.uid, course.id, eje.id);
          showCourseDetail(course);
        } else {
          alert('‚úó Incorrecto. Prob√° de nuevo.');
        }
      };
      quizContainer.appendChild(btn);
    });
    
    content.appendChild(quizContainer);
    
    if (!unlocked) {
      const lockBadge = document.createElement('div');
      lockBadge.className = 'lock-badge';
      lockBadge.innerText = 'üîí Bloqueado';
      ejeCard.appendChild(lockBadge);
    } else if (approvedSet.has(eje.id)) {
      const okBadge = document.createElement('div');
      okBadge.className = 'lock-badge success-badge';
      okBadge.innerText = '‚úì Aprobado';
      ejeCard.appendChild(okBadge);
    }
    
    ejeCard.appendChild(header);
    ejeCard.appendChild(content);
    courseDetailEl.appendChild(ejeCard);
  }
}

async function renderWorkshops() {
  workshopsEl.innerHTML = '';
  
  for (const w of demoWorkshops) {
    const card = document.createElement('div');
    card.className = 'p-4 bg-white rounded shadow-sm flex flex-col hover:shadow-md transition-shadow';
    
    card.innerHTML = `
      <h4 class="font-semibold text-[var(--accent)] text-lg">${w.title}</h4>
      <p class="text-sm text-gray-500 mt-1">${w.description}</p>
      <p class="mt-2 font-bold text-[var(--accent)] text-xl">USD ${w.price}</p>
    `;
    
    const btnPay = document.createElement('button');
    btnPay.className = 'btn-accent px-3 py-2 rounded mt-3 font-semibold';
    btnPay.innerText = 'Comprar Taller';
    btnPay.onclick = () => processPayment(w.id, w.price, w.title);
    card.appendChild(btnPay);
    
    const vcontainer = document.createElement('div');
    vcontainer.className = 'mt-3 video-container rounded overflow-hidden';
    
    const iframe = document.createElement('iframe');
    iframe.width = '100%';
    iframe.height = 180;
    iframe.src = w.videos[0].url + '?controls=1&rel=0';
    iframe.style.border = 'none';
    
    const paid = currentUser ? await hasPaid(currentUser.uid, w.id) : false;
    
    if (!paid || isDemo) {
      iframe.style.opacity = '0.4';
      iframe.style.pointerEvents = 'none';
      
      const overlay = document.createElement('div');
      overlay.className = 'video-overlay';
      overlay.innerHTML = `
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
          <path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="white"/>
          <path d="M19 8h-1V6c0-2.76-2.24-5-5-5H11c-2.76 0-5 2.24-5 5v2H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8 6c0-1.66 1.34-3 3-3h2c1.66 0 3 1.34 3 3v2H8V6zm11 14H5V10h14v10z" fill="white"/>
        </svg>
        <span>${isDemo ? 'üîí Demo - Registrate' : 'üîí Pago requerido'}</span>
      `;
      overlay.onclick = () => {
        if (isDemo) {
          alert('Modo demo: registrate y pag√° para ver el taller.');
        } else {
          alert('Pag√° el taller para ver el video completo.');
        }
      };
      vcontainer.appendChild(iframe);
      vcontainer.appendChild(overlay);
    } else {
      vcontainer.appendChild(iframe);
    }
    
    card.appendChild(vcontainer);
    workshopsEl.appendChild(card);
  }
}

function showMainContent(user) {
  currentUser = user;
  if (user) {
    document.getElementById('main-content').classList.add('visible');
    document.getElementById('login-wrapper').style.display = 'none';
    isDemo = false;
  } else {
    document.getElementById('main-content').classList.remove('visible');
    document.getElementById('login-wrapper').style.display = 'flex';
    isDemo = false;
  }
}

async function login() {
  try {
    if (auth.currentUser) {
      await signOut(auth);
    } else {
      await signInWithPopup(auth, new GoogleAuthProvider());
    }
  } catch (e) {
    alert("Error al iniciar sesi√≥n: " + (e.message || e));
    console.error(e);
  }
}

async function updateZoomButtonVisibility() {
  const m = demoMembership[0];
  if (!btnJoinZoom) return;
  
  const paid = currentUser ? await hasPaid(currentUser.uid, m.id) : false;
  
  if (paid && !isDemo) {
    btnJoinZoom.style.display = 'block';
    btnJoinZoom.onclick = () => {
      const root = document.getElementById('modal-root');
      root.style.display = 'block';
      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal p-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-xl font-bold">Clases en vivo por Zoom</h3>
              <button id="zoom-modal-close" class="px-3 py-1 rounded border hover:bg-gray-100">Cerrar</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Seleccion√° la clase a la que quer√©s unirte:</p>
            <div class="space-y-2">
              ${m.zoom.map(z => `
                <a href="${z.url}" target="_blank" class="block p-3 border rounded hover:bg-gray-50 transition">
                  <strong>${z.label}</strong>
                  <p class="text-xs text-gray-500 mt-1">Click para abrir Zoom</p>
                </a>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.getElementById('zoom-modal-close').onclick = () => {
        root.style.display = 'none';
        root.innerHTML = '';
      };
    };
  } else {
    btnJoinZoom.style.display = 'none';
  }
}

if (btnLoginOverlay) {
  btnLoginOverlay.addEventListener('click', login);
}

if (btnLoginNav) {
  btnLoginNav.addEventListener('click', login);
}

if (btnGuest) {
  btnGuest.addEventListener('click', () => {
    isDemo = true;
    document.getElementById('login-wrapper').style.display = 'none';
    document.getElementById('main-content').classList.add('visible');
    renderMembership();
    renderCourses();
    renderWorkshops();
    membershipPreviewEl.style.display = 'block';
    populatePreviewGrid();
  });
}

if (btnMiniPay) {
  btnMiniPay.addEventListener('click', async () => {
    if (!currentUser) {
      alert('Inici√° sesi√≥n para comprar el curso.');
      return;
    }
    await processPayment('basic', 49, 'Nivel Inicial');
  });
}

if (btnPayMembership) {
  btnPayMembership.addEventListener('click', async () => {
    const m = demoMembership[0];
    if (!currentUser) {
      alert('Inici√° sesi√≥n para comprar la membres√≠a.');
      return;
    }
    await processPayment(m.id, m.price, m.title);
  });
}

if (btnMembershipOpen) {
  btnMembershipOpen.addEventListener('click', () => {
    if (membershipPreviewEl.style.display === 'none' || membershipPreviewEl.style.display === '') {
      membershipPreviewEl.style.display = 'block';
      populatePreviewGrid();
      btnMembershipOpen.innerText = 'Ocultar Clases';
    } else {
      membershipPreviewEl.style.display = 'none';
      btnMembershipOpen.innerText = 'Ver Clases Grabadas';
    }
  });
}

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    if (btnLoginNav) {
      btnLoginNav.innerText = `Salir (${user.displayName?.split(' ')[0] || 'Usuario'})`;
    }
    isDemo = false;
    
    try {
      const userRef = doc(db, 'users', user.uid);
      await setDoc(userRef, {
        displayName: user.displayName || null,
        email: user.email || null,
        lastSeen: new Date().toISOString()
      }, { merge: true });
    } catch (e) {
      console.error('Error guardando perfil:', e);
    }
  } else {
    currentUser = null;
    if (btnLoginNav) {
      btnLoginNav.innerText = 'Entrar / Registrarme';
    }
  }
  
  await renderMembership();
  await renderCourses();
  await renderWorkshops();
  showMainContent(user);
  await updateZoomButtonVisibility();
  await handleReturnFromMP();
});

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => heroBg.classList.add('animate'), 600);
  handleReturnFromMP().catch(e => console.error(e));
  renderMembership();
  renderCourses();
  renderWorkshops();
});

</script>
</body>
</html>
